name: Build and Deploy

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Install Nim
      run: |
        curl https://nim-lang.org/choosenim/init.sh -sSf | sh -s -- -y
        echo "$HOME/.nimble/bin" >> $GITHUB_PATH
    
    - name: Setup Emscripten
      uses: mymindstorm/setup-emsdk@v14
      with:
        version: 'latest'
    
    - name: Verify installations
      run: |
        echo "==> Nim version:"
        nim --version
        echo ""
        echo "==> Emscripten version:"
        emcc --version
    
    - name: Build Linux Binary
      run: |
        echo "==> Building Linux binary..."
        nim c -d:release -o:prehistorie prehistorie.nim
        chmod +x prehistorie
        
        # Package it
        tar -czf prehistorie-linux-x64.tar.gz prehistorie README.md
        
        echo "âœ“ Linux binary built and packaged"
        ls -lh prehistorie prehistorie-linux-x64.tar.gz
    
    - name: Build WebAssembly
      run: |
        echo "==> Building WebAssembly..."
        nim c -d:emscripten \
          --os:linux --cpu:wasm32 \
          --cc:clang --clang.exe:emcc --clang.linkerexe:emcc \
          --passC:"-s WASM=1" \
          --passL:"-s WASM=1" \
          --passL:"-s EXPORTED_FUNCTIONS='[\"_emInit\",\"_emUpdate\",\"_emResize\",\"_emGetWidth\",\"_emGetHeight\",\"_emGetCell\",\"_emGetCellStyle\",\"_emHandleKey\",\"_main\"]'" \
          --passL:"-s EXPORTED_RUNTIME_METHODS='[\"ccall\",\"cwrap\",\"UTF8ToString\"]'" \
          --passL:"-s ALLOW_MEMORY_GROWTH=1" \
          --passL:"-s MODULARIZE=0" \
          --passL:"-s ENVIRONMENT=web" \
          --passL:"-s INITIAL_MEMORY=16MB" \
          -o:prehistorie.wasm.js \
          prehistorie.nim
        
        # Fix double .wasm extension
        if [ -f "prehistorie.wasm.wasm" ]; then
          mv prehistorie.wasm.wasm prehistorie.wasm
          echo "âœ“ Fixed: .wasm.wasm â†’ .wasm"
        fi
        
        # Fix references in JS
        if [ -f "prehistorie.wasm.js" ]; then
          sed -i 's/prehistorie\.wasm\.wasm/prehistorie.wasm/g' prehistorie.wasm.js
          echo "âœ“ Fixed JS references"
        fi
    
    - name: Verify builds
      run: |
        echo "==> Verifying builds..."
        
        # Check files exist
        for file in prehistorie prehistorie-linux-x64.tar.gz prehistorie.wasm prehistorie.wasm.js; do
          if [ ! -f "$file" ]; then
            echo "âŒ Missing: $file"
            exit 1
          fi
        done
        
        # Check for bad references
        if grep -q "\.wasm\.wasm" prehistorie.wasm.js; then
          echo "âŒ Found .wasm.wasm references in JS"
          exit 1
        fi
        
        echo "âœ“ All builds verified"
        echo ""
        echo "==> Build artifacts:"
        ls -lh prehistorie prehistorie-linux-x64.tar.gz prehistorie.wasm prehistorie.wasm.js
    
    - name: Prepare GitHub Pages
      run: |
        mkdir -p deploy
        
        # Copy web files
        cp index.html deploy/
        cp prehistorie.js deploy/
        cp prehistorie.wasm.js deploy/
        cp prehistorie.wasm deploy/
        
        # Add download section to the page
        cat >> deploy/index.html << 'EOF'
        <div style="position: fixed; bottom: 20px; right: 20px; background: #1a1a1a; border: 2px solid #333; border-radius: 8px; padding: 15px; font-family: monospace;">
          <div style="color: #0f0; font-weight: bold; margin-bottom: 10px;">ğŸ“¦ Downloads</div>
          <a href="https://github.com/${{ github.repository }}/raw/main/prehistorie-linux-x64.tar.gz" 
             style="display: block; color: #0ff; text-decoration: none; margin: 5px 0;"
             download>ğŸ§ Linux Binary</a>
          <a href="https://github.com/${{ github.repository }}" 
             style="display: block; color: #0ff; text-decoration: none; margin: 5px 0;">
             ğŸ“– View Source</a>
        </div>
        EOF
        
        echo "âœ“ GitHub Pages prepared"
    
    - name: Upload Linux binary
      uses: actions/upload-artifact@v4
      with:
        name: linux-binary
        path: prehistorie-linux-x64.tar.gz
        retention-days: 90
    
    - name: Upload web files
      uses: actions/upload-artifact@v4
      with:
        name: web-files
        path: |
          prehistorie.wasm
          prehistorie.wasm.js
          prehistorie.js
          index.html
        retention-days: 90
    
    - name: Upload Pages artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: 'deploy'
    
    - name: Commit Linux binary to repo (if changed)
      if: github.event_name == 'push'
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        
        # Only commit if file changed
        if [ -f prehistorie-linux-x64.tar.gz ]; then
          git add -f prehistorie-linux-x64.tar.gz || true
          git diff --staged --quiet || git commit -m "ğŸ¤– Auto-build: Update Linux binary [skip ci]"
          git push || echo "No changes to push"
        fi
      continue-on-error: true

  deploy-pages:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push'
    
    steps:
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
    
    - name: Post deployment info
      run: |
        echo "ğŸ‰ Deployment successful!"
        echo "ğŸŒ Web version: ${{ steps.deployment.outputs.page_url }}"
        echo "ğŸ“¦ Linux binary: Available as artifact"